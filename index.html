<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>ALC Smart Mapper</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <style>
        body {
            background: #000;
            color: #aaa;
            font-family: monospace;
            padding: 10px;
        }

        .status {
            padding: 10px;
            border: 2px solid #aaa;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
        }

        .log {
            font-size: 11px;
            border-bottom: 1px solid #333;
            padding: 4px;
            word-break: break-all;
        }

        .hit {
            color: #0f0;
            background: #040;
            font-weight: bold;
            border: 1px solid #0f0;
        }

        .map {
            color: #fb0;
        }

        .unique {
            color: #aaf;
        }
    </style>

    <script>
        // --- UTILS ---
        window.pushLog = (msg, type) => {
            const el = document.getElementById('logs');
            if (el) {
                const div = document.createElement('div');
                div.className = "log " + (type || "");
                div.textContent = msg; // Text only to be safe
                el.insertBefore(div, el.firstChild);
                // Limit history
                if (el.children.length > 100) el.removeChild(el.lastChild);
            }
        };

        window.updateStatus = (msg) => {
            const el = document.getElementById('status');
            if (el) el.textContent = msg;
        };

        // --- SMART MAPPER ---
        window.knownNames = new Set();

        // Ranges of interest:
        // 0-100: Basic Proto
        // 1000-1100: ???
        // 2000-2200: Open API v2
        window.ranges = [
            [0, 100],
            [1000, 1050],
            [2000, 2200]
        ];
        window.currentRangeIdx = 0;
        window.currentId = 0;
        window.isScanning = false;

        window.startSmartScan = () => {
            if (window.isScanning) return;
            window.isScanning = true;

            window.currentRangeIdx = 0;
            window.currentId = window.ranges[0][0];
            window.scanNext();
        };

        window.scanNext = () => {
            if (!window.isScanning) return;

            // Check bounds
            const range = window.ranges[window.currentRangeIdx];
            if (window.currentId > range[1]) {
                // Next range
                window.currentRangeIdx++;
                if (window.currentRangeIdx >= window.ranges.length) {
                    window.updateStatus("SCAN COMPLETE");
                    window.isScanning = false;
                    return;
                }
                window.currentId = window.ranges[window.currentRangeIdx][0];
            }

            const id = window.currentId;
            window.updateStatus(`SCANNING: ${id}`);

            // Send
            const bridge = window.EventBasedPluginJavaScriptBridge;
            try {
                bridge.handlePluginEvent(JSON.stringify({
                    payloadType: id,
                    clientMsgId: "map-" + id,
                    payload: {}
                }));
            } catch (e) { }

            window.currentId++;

            // SLOW DOWN: 50ms = 20 req/s. Should be safe.
            // If crash recurs, user can report, we increase to 200ms.
            setTimeout(window.scanNext, 50);
        };

        // --- HANDLER ---
        window.onHostMessage = (msg) => {
            if (!msg) return;

            if (msg.payloadType === 2000) {
                // Only start once
                if (!window.isScanning) {
                    window.pushLog(`<< RECV 2000. Starting Gentle Scan...`);
                    window.startSmartScan();
                }
            }
            else if (msg.payloadType === 2500) {
                // ERROR: "Unsupported...: NAME"
                const idStr = msg.clientMsgId.replace("map-", "");
                const txt = msg.payload || "";

                // Extract Name
                let name = "Unknown";
                if (txt.includes(": ")) {
                    name = txt.split(": ")[1];
                } else {
                    name = txt;
                }

                // UNLOCK: Only log UNIQUE names to save memory/UI
                if (!window.knownNames.has(name)) {
                    window.knownNames.add(name);

                    // Highlight gold
                    if (name.toLowerCase().includes("auth") ||
                        name.toLowerCase().includes("sub") ||
                        name.toLowerCase().includes("req")) {
                        window.pushLog(`!!! FOUND ID ${idStr}: ${name}`, "hit");
                    } else {
                        window.pushLog(`New Type [${idStr}]: ${name}`, "unique");
                    }
                }

                // Always update status with last found
                // window.updateStatus(`SCANNING ${window.currentId} (Found: ${name})`);
            }
            else {
                // SUCCESS?
                window.pushLog(`!!! VALID RESPONSE [${msg.payloadType}] !!!`, "hit");
            }
        };

        // --- SETUP ---
        window.onload = () => {
            window.pushLog("Inspector v33: Gentle Mapper");
            window.addEventListener('message-from-host', (e) => window.onHostMessage(e.data));
        };

    </script>
</head>

<body>
    <div id="status" class="status">WAITING 2000...</div>

    <p style="font-size:12px; text-align:center; color:#aaa;">
        Inspector v33: Gentle & Unique Log
    </p>

    <div id="logs" style="margin-top:10px;"></div>
</body>

</html>