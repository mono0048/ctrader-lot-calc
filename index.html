<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Auto Lot Calc v6.0</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <style>
        body {
            background: #121212;
            color: #f5f5f5;
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            margin: 0;
        }

        .card {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
            display: block;
            font-weight: 600;
        }

        .value {
            font-size: 22px;
            font-weight: 700;
            color: #fff;
        }

        .mono {
            font-family: "Roboto Mono", monospace;
            letter-spacing: -0.5px;
        }

        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .col {
            display: flex;
            flex-direction: column;
        }

        input,
        select,
        button {
            width: 100%;
            box-sizing: border-box;
            padding: 14px;
            background: #2a2a2a;
            border: 1px solid #333;
            color: #fff;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            -webkit-appearance: none;
        }

        input:focus,
        select:focus {
            border-color: #448aff;
            background: #333;
        }

        button.trade {
            background: linear-gradient(135deg, #2962ff, #448aff);
            border: none;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(41, 98, 255, 0.4);
            margin-top: 10px;
        }

        button.trade:disabled {
            background: #333;
            color: #555;
            box-shadow: none;
        }

        #log {
            display: block;
            font-size: 10px;
            color: #666;
            white-space: pre-wrap;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            height: 150px;
            overflow-y: auto;
        }

        #modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: #1e1e1e;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            max-width: 80%;
            border: 1px solid #333;
        }
    </style>

    <script>
        function P(obj, key) {
            if (!obj) return undefined;
            if (obj[key] !== undefined) return obj[key];
            const pascal = key.charAt(0).toUpperCase() + key.slice(1);
            if (obj[pascal] !== undefined) return obj[pascal];
            const camel = key.charAt(0).toLowerCase() + key.slice(1);
            if (obj[camel] !== undefined) return obj[camel];
            return undefined;
        }

        const App = {
            account: "---",
            balance: 0,
            currency: "???", // Default to ??? to force check
            allSymbols: [],
            symbol: null,
            price: 0,
            volCents: 0,
            volLots: 0
        };

        const Tunnel = {
            queue: new Map(),
            send: (id, pl, cb) => {
                const mid = "req-" + id + "-" + Date.now() + Math.random().toString(36).substr(2, 5);
                if (cb) Tunnel.queue.set(mid, cb);
                const w = { payloadType: 2100, clientMsgId: "w-" + mid, payload: { payloadType: id, clientMsgId: mid, payload: pl || {} } };
                try { window.EventBasedPluginJavaScriptBridge.handlePluginEvent(JSON.stringify(w)); } catch (e) { }
            },
            onMsg: (w) => {
                let inn = null;
                try {
                    if (w.payloadType === 2101 || w.payloadType === 2102) {
                        const py = w.payload;
                        inn = (py && py.data && typeof py.data === 'string') ? JSON.parse(py.data) : py;
                    }
                } catch (e) { }
                if (!inn) return;

                const mid = P(inn, "clientMsgId");
                const pl = P(inn, "payload");
                if (mid && Tunnel.queue.has(mid)) { Tunnel.queue.get(mid)(pl); Tunnel.queue.delete(mid); }

                const type = P(inn, "payloadType");
                if (type === 3 || type === "PROTO_QUOTE_EVENT") Logic.onQuote(inn.payload || inn);
            }
        };

        const Logic = {
            init: () => {
                window.addEventListener('message-from-host', e => {
                    const m = e.data;
                    if (m.payloadType === 2000) {
                        try { window.EventBasedPluginJavaScriptBridge.handlePluginEvent(JSON.stringify({ payloadType: 2001, clientMsgId: m.clientMsgId, payload: null })); } catch (e) { }
                        if (!App.ready) { App.ready = true; Logic.start(); }
                    } else { Tunnel.onMsg(m); }
                });
                ['in_risk', 'in_sl'].forEach(id => document.getElementById(id).oninput = Logic.calc);
                document.getElementById('btn_trade').onclick = Logic.trade;
                document.getElementById('sym_filter').oninput = (e) => UI.filterSyms(e.target.value);
            },

            start: () => {
                document.getElementById('status').innerText = "ONLINE";
                document.getElementById('status').style.color = "#00e676";
                Tunnel.send(175, {}, res => {
                    // DEBUG: Log Account to find Currency
                    UI.log("AccRes: " + JSON.stringify(res));

                    const t = P(res, "trader");
                    if (t) {
                        App.account = P(t, "login");
                        App.balance = (P(t, "balance") || 0) / 100;
                        App.currency = P(res, "depositCurrency") || "USD";

                        // Force JPY override if name suggests?
                        UI.updateAcc();
                        Logic.loadSyms();
                    }
                });
            },

            loadSyms: () => {
                Tunnel.send(841, { includeArchivedSymbols: false }, res => {
                    const s = P(res, "symbol");
                    if (s) {
                        s.sort((a, b) => P(a, "name").localeCompare(P(b, "name")));
                        App.allSymbols = s;
                        UI.filterSyms("JPY");
                    }
                });
            },

            selectSym: (id) => {
                Tunnel.send(163, { symbolId: [id] }, res => {
                    const l = P(res, "symbol");
                    if (l && l[0]) {
                        App.symbol = l[0];
                        App.symbol.id = id;

                        // --- DYNAMIC DATA v6.0 ---
                        const stepCents = P(App.symbol, "stepVolume") || 100000;
                        App.symbol._step = stepCents; // Keep in Cents for calculation logic

                        UI.log(`Sel: ${P(App.symbol, "name")} Fav:${P(App.symbol, "favorite")} Lot:${P(App.symbol, "lotSize")}`);

                        Tunnel.send(601, { symbolId: [id], subscribeToSpotTimestamp: true });
                        Logic.calc();
                    }
                });
            },

            onQuote: (q) => {
                const sid = P(q, "symbolId");
                if (App.symbol && P(App.symbol, "id") == sid) {
                    const bid = P(q, "bid");
                    if (bid) {
                        App.price = bid / 100000;
                        UI.updatePrice();
                        Logic.calc();
                    }
                }
            },

            calc: () => {
                if (!App.symbol || !App.price) return;
                const r = parseFloat(document.getElementById('in_risk').value);
                const sl = parseFloat(document.getElementById('in_sl').value);
                if (!r || !sl) return;

                const riskAmt = App.balance * (r / 100);

                // --- FULLY DYNAMIC PIP VALUE ---
                const lotCents = P(App.symbol, "lotSize") || 10000000; // 100k units * 100
                const lotUnits = lotCents / 100;

                const digits = P(App.symbol, "digits");
                const pipPos = P(App.symbol, "pipPosition") || (digits === 3 ? 2 : 4);
                const pipSize = Math.pow(10, -pipPos); // e.g. 10^-2 = 0.01

                // Value per Lot in QUOTE Currency
                const pipValQuote = lotUnits * pipSize;

                // Convert to Account Currency
                const sym = P(App.symbol, "name").toUpperCase();
                const acc = App.currency.toUpperCase();

                let finalPipVal = 10; // Default fallback

                // Logic:
                // 1. If Account matches Quote (e.g. Acc=JPY, Pair=USDJPY) -> No Conv (pipValQuote)
                // 2. If Account matches Base (e.g. Acc=USD, Pair=USDJPY) -> pipValQuote / Price
                // 3. If Account is neither (e.g. Acc=USD, Pair=EURJPY) -> pipValQuote (JPY) * JPYUSD_Rate.

                // Detection:
                if (sym.endsWith(acc)) {
                    // Quote is Account
                    finalPipVal = pipValQuote;
                } else if (sym.startsWith(acc)) {
                    // Base is Account. (e.g. USDJPY, Acc=USD). Quote is JPY.
                    // We have pipVal in JPY. We need USD. 
                    // 1 USD = Price JPY. -> 1 JPY = 1/Price USD.
                    finalPipVal = pipValQuote / App.price;
                } else {
                    // Cross. Hard/Imprecise without rate.
                    // e.g. EURUSD on JPY Account.
                    // Quote is USD. We need JPY.
                    // Scan for "USDJPY" rate? Or assume fixed?
                    // For this version, fallback to 1000 if JPY, 10 if USD.
                    finalPipVal = (acc === "JPY") ? 1000 : 10;
                }

                // Calculate
                const lots = riskAmt / (sl * finalPipVal);

                // Normalize to Step (Cents)
                let unitsCents = lots * lotCents; // Target Cents
                const stepCents = App.symbol._step || 100000;

                unitsCents = Math.floor(unitsCents / stepCents) * stepCents;

                App.volCents = unitsCents;
                App.volLots = unitsCents / lotCents; // Display Lots matches LotSize

                UI.updateCalc(riskAmt, finalPipVal);
            },

            trade: () => {
                if (App.volCents <= 0) return;
                document.getElementById('btn_trade').innerText = "...";
                document.getElementById('btn_trade').disabled = true;

                const cmd = {
                    symbolId: App.symbol.id,
                    orderType: 1, tradeSide: 1, volume: App.volCents
                };

                Tunnel.send(143, cmd, res => {
                    document.getElementById('btn_trade').innerText = "PLACE ORDER";
                    document.getElementById('btn_trade').disabled = false;

                    const err = P(res, "errorCode");
                    if (err) UI.showModal("ERROR", err);
                    else UI.showModal("SUCCESS", `Ordered ${App.volLots.toFixed(2)} Lots`);
                });
            }
        };

        const UI = {
            updateAcc: () => {
                document.getElementById('acc_id').textContent = App.account;
                document.getElementById('acc_bal').textContent = App.balance.toLocaleString() + " " + App.currency;
            },
            filterSyms: (txt) => {
                const s = document.getElementById('sym_select');
                s.innerHTML = "";
                const term = (txt || "").toUpperCase();

                // Future: filter by favorites if we can map IDs
                const matches = App.allSymbols.filter(x => P(x, "name").toUpperCase().includes(term));

                matches.slice(0, 50).forEach(i => {
                    const o = document.createElement('option');
                    o.value = P(i, "id");
                    o.text = P(i, "name");
                    s.add(o);
                });
            },
            updatePrice: () => document.getElementById('lbl_price').textContent = App.price.toFixed(3),
            updateCalc: (risk, pv) => {
                document.getElementById('out_lots').textContent = App.volLots.toFixed(2) + " Lots";
                document.getElementById('out_risk').textContent = "Risk: " + Math.floor(risk) + " " + App.currency;
                document.getElementById('btn_trade').disabled = (App.volCents <= 0);

                // Debug info
                // document.getElementById('debug_pv').textContent = "PV: " + pv.toFixed(2);
            },
            showModal: (title, msg) => {
                const m = document.getElementById('modal');
                m.style.display = "flex";
                m.querySelector('.modal-content').innerHTML = `
                <h3 style="color:${title === 'SUCCESS' ? '#00e676' : '#ff5252'}">${title}</h3><p>${msg}</p>
                <button onclick="document.getElementById('modal').style.display='none'" style="margin-top:10px;background:#444">CLOSE</button>
            `;
            },
            log: (t) => {
                const l = document.getElementById('log');
                l.textContent = t + "\n" + l.textContent.substring(0, 2000);
            }
        };

        window.onload = Logic.init;
    </script>
</head>

<body>
    <div class="row" style="margin-bottom:10px">
        <div style="font-weight:900; font-size:18px; color:#448aff; letter-spacing:1px;">AUTO LOT<span
                style="color:#fff">CALC</span> v6.0</div>
        <div id="status" style="font-size:10px; font-weight:bold; color:#555">OFFLINE</div>
    </div>

    <div class="card" style="background: linear-gradient(135deg, #1e1e1e, #252525);">
        <div class="row">
            <div class="col">
                <span class="label">Balance</span>
                <div class="value mono" id="acc_bal">---</div>
            </div>
            <div class="col" style="align-items:flex-end">
                <span class="label">Account</span>
                <div class="value" id="acc_id" style="font-size:16px; color:#888;">---</div>
            </div>
        </div>
    </div>

    <div class="card">
        <span class="label">Trading Pair</span>
        <input type="text" id="sym_filter" placeholder="Search (e.g. USDJPY)...">
        <select id="sym_select" size="5" onchange="Logic.selectSym(parseInt(this.value))"></select>

        <div style="margin-top:10px; text-align:center;">
            <div class="value mono" id="lbl_price" style="font-size:28px; color:#aaa">---</div>
        </div>
    </div>

    <div class="row" style="gap:15px; margin-bottom:16px;">
        <div class="card" style="flex:1; margin:0; padding:15px; background:#252525">
            <span class="label">Risk %</span>
            <input type="number" id="in_risk" value="1.0" step="0.1">
        </div>
        <div class="card" style="flex:1; margin:0; padding:15px; background:#252525">
            <span class="label">SL (Pips)</span>
            <input type="number" id="in_sl" value="20" step="1">
        </div>
    </div>

    <div class="card" style="border: 1px solid #333;">
        <div class="row">
            <span class="label">Volume</span>
            <span class="label" id="out_risk">Risk: 0</span>
        </div>
        <div class="value mono" id="out_lots" style="font-size:36px; color:#448aff; margin:10px 0;">0.00 Lots</div>

        <button id="btn_trade" class="trade" disabled>Place Order</button>
    </div>

    <div id="log">Debug Info...</div>
    <div id="modal">
        <div class="modal-content"></div>
    </div>
</body>

</html>