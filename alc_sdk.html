<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>ALC Tunnel Fuzzer</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <style>
        body {
            background: #102;
            color: #f0f;
            font-family: monospace;
            padding: 10px;
        }

        .status {
            padding: 10px;
            border: 2px solid #f0f;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
        }

        .log {
            font-size: 11px;
            border-bottom: 1px solid #404;
            padding: 4px;
            word-break: break-all;
        }

        .try {
            color: #d8f;
        }

        .hit {
            color: #fff;
            background: #c00;
            font-weight: bold;
            border: 2px solid #fff;
            padding: 5px;
        }
    </style>

    <script>
        // --- UTILS ---
        window.pushLog = (msg, type) => {
            const el = document.getElementById('logs');
            if (el) {
                const div = document.createElement('div');
                div.className = "log " + (type || "");
                div.textContent = `[${new Date().toLocaleTimeString().split(' ')[0]}] ${msg}`;
                el.insertBefore(div, el.firstChild);
            }
        };

        window.updateStatus = (msg) => {
            const el = document.getElementById('status');
            if (el) el.textContent = msg;
        };

        // --- TUNNEL FUZZER ---
        window.fuzzTunnel = (initMsgId) => {
            const bridge = window.EventBasedPluginJavaScriptBridge;
            if (!bridge) return;

            // ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const accId = parseInt(urlParams.get("id")) || 2614946;

            window.updateStatus("FUZZING TUNNEL (2100)...");

            // HEARTBEAT
            try { bridge.handlePluginEvent(JSON.stringify({ payloadType: 2001, clientMsgId: initMsgId, payload: null })); } catch (e) { }

            // TARGET: 2102 (Account Auth) -> The inner message we want to send
            const innerMsgObj = {
                payloadType: 2102,
                clientMsgId: "inner-" + Date.now(),
                payload: {
                    ctidTraderAccountId: accId,
                    token: "dummy_token"
                }
            };
            const innerMsgStr = JSON.stringify(innerMsgObj);

            // VARIATIONS
            const variations = [
                // 1. ROOT PAYLOAD (Object)
                { name: "Payload:Obj", json: { payloadType: 2100, clientMsgId: "t1", payload: innerMsgObj } },
                // 2. ROOT PAYLOAD (String)
                { name: "Payload:Str", json: { payloadType: 2100, clientMsgId: "t2", payload: innerMsgStr } },
                // 3. DATA FIELD
                { name: "Data:Obj", json: { payloadType: 2100, clientMsgId: "t3", payload: { data: innerMsgObj } } },
                { name: "Data:Str", json: { payloadType: 2100, clientMsgId: "t4", payload: { data: innerMsgStr } } },
                // 4. MESSAGE FIELD
                { name: "Msg:Obj", json: { payloadType: 2100, clientMsgId: "t5", payload: { message: innerMsgObj } } },
                // 5. PROTO MESSAGE
                { name: "Proto:Obj", json: { payloadType: 2100, clientMsgId: "t6", payload: { protoMessage: innerMsgObj } } },
                // 6. FLAT (Merge)
                { name: "Flat:Merge", json: { payloadType: 2100, clientMsgId: "t7", payloadType: 2100, ...innerMsgObj } } // Bad JSON but try valid merge
                // { payloadType: 2100, clientMsgId: "t7", ctidTraderAccountId... }
            ];

            // Special Flat Construction
            const flatObj = { payloadType: 2100, clientMsgId: "t8", ...innerMsgObj.payload };
            variations.push({ name: "Flat:Props", json: flatObj });

            let delay = 200;
            variations.forEach(v => {
                setTimeout(() => {
                    try {
                        bridge.handlePluginEvent(JSON.stringify(v.json));
                        window.pushLog(`>> SENT [${v.name}]`, "try");
                    } catch (e) { }
                }, delay);
                delay += 800;
            });
        };

        // --- HANDLER ---
        window.processedHeartbeats = new Set();
        window.onHostMessage = (msg) => {
            if (!msg) return;

            if (msg.payloadType === 2000) {
                if (window.processedHeartbeats.has(msg.clientMsgId)) return;
                window.processedHeartbeats.add(msg.clientMsgId);

                window.pushLog(`<< RECV 2000`);
                window.fuzzTunnel(msg.clientMsgId);
            }
            else if (msg.payloadType === 2101) {
                // 2101 = SendServerDataRes (ACK)
                window.updateStatus("!!! TUNNEL OPENED (2101) !!!");
                window.pushLog(`!!! ACK RECV [2101] !!! ${JSON.stringify(msg)}`, "hit");
            }
            else if (msg.payloadType === 2102) {
                // 2102 = ServerDataEvent (DATA)
                window.updateStatus("!!! DATA FLOWING (2102) !!!");
                window.pushLog(`!!! DATA RECV [2102] !!! ${JSON.stringify(msg)}`, "hit");
            }
            else if (msg.payloadType === 2500) {
                // Error
                const txt = msg.payload || "";
                // Ignore "Unsupported" logs if possible to reduce noise, unless unique
                if (txt.includes("Unsupported")) {
                    // window.pushLog("Err: 2500 Unsupported"); 
                } else {
                    window.pushLog(`Err [2500]: ${txt}`, "try");
                }
            }
        };

        // --- SETUP ---
        window.onload = () => {
            window.pushLog("Inspector v35: Tunnel Fuzzer");
            window.addEventListener('message-from-host', (e) => window.onHostMessage(e.data));
        };

    </script>
</head>

<body>
    <div id="status" class="status">WAITING 2000...</div>

    <p style="font-size:12px; text-align:center; color:#aaa;">
        Inspector v35: Finding the Wrapper
    </p>

    <div id="logs" style="margin-top:10px;"></div>
</body>

</html>