<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>ALC v4.2 (Debug)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <style>
        body {
            background: #121212;
            color: #f5f5f5;
            font-family: monospace;
            padding: 10px;
            margin: 0;
        }

        .card {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #333;
        }

        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        input,
        select,
        button {
            width: 100%;
            padding: 12px;
            background: #2a2a2a;
            border: 1px solid #333;
            color: #fff;
            margin-top: 5px;
        }

        button.trade {
            background: #2962ff;
            font-weight: bold;
        }

        #log {
            font-size: 10px;
            color: #0f0;
            white-space: pre-wrap;
            border-top: 1px solid #333;
            margin-top: 20px;
            padding-top: 10px;
            height: 300px;
            overflow-y: scroll;
        }

        .label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
        }

        .val {
            font-size: 18px;
            font-weight: bold;
        }
    </style>

    <script>
        function P(o, k) {
            if (!o) return undefined;
            if (o[k] !== undefined) return o[k];
            var c = k[0].toUpperCase() + k.slice(1);
            if (o[c] !== undefined) return o[c];
            c = k[0].toLowerCase() + k.slice(1);
            if (o[c] !== undefined) return o[c];
            return undefined;
        }

        const App = { acc: "---", bal: 0, cur: "USD", sym: null, bid: 0, vol: 0 };

        const Tunnel = {
            q: new Map(),
            send: (id, pl, cb) => {
                const mid = "r-" + id + "-" + Math.random().toString(36).substr(2, 5);
                if (cb) Tunnel.q.set(mid, cb);
                const w = { payloadType: 2100, clientMsgId: mid, payload: { payloadType: id, clientMsgId: mid, payload: pl || {} } };
                try { window.EventBasedPluginJavaScriptBridge.handlePluginEvent(JSON.stringify(w)); } catch (e) { log("SendFail:" + e); }
            },
            onMsg: (w) => {
                let i = w.payload;
                // Unwrap 2101/2102 data string
                if ((w.payloadType === 2101 || w.payloadType === 2102) && i && i.data && typeof i.data === 'string') {
                    try { i = JSON.parse(i.data); } catch (e) { }
                }
                if (!i) return;

                const mid = P(i, "clientMsgId");
                const type = P(i, "payloadType");
                const pl = P(i, "payload");

                // Logs for debugging 601/3
                if (type !== 2001) { // Ignore Heartbeat ACK
                    // log(`In[${type}] mid=${mid}`);
                }

                if (mid && Tunnel.q.has(mid)) {
                    Tunnel.q.get(mid)(pl);
                    Tunnel.q.delete(mid);
                }

                // Events
                if (type === 3 || type === "PROTO_QUOTE_EVENT") Logic.onQuote(i); // Pass WHOLE msg
            }
        };

        const Logic = {
            init: () => {
                window.addEventListener('message-from-host', e => {
                    const m = e.data;
                    if (m.payloadType === 2000) {
                        try { window.EventBasedPluginJavaScriptBridge.handlePluginEvent(JSON.stringify({ payloadType: 2001, clientMsgId: m.clientMsgId, payload: null })); } catch (e) { }
                        if (!App.ready) { App.ready = true; Logic.start(); }
                    } else {
                        Tunnel.onMsg(m);
                    }
                });
                document.getElementById('trade').onclick = Logic.trade;
                document.getElementById('risk').oninput = Logic.calc;
            },
            start: () => {
                log("Connected. Fetching Acc...");
                Tunnel.send(175, {}, r => {
                    const t = P(r, "trader");
                    if (t) {
                        App.acc = P(t, "login");
                        App.bal = (P(t, "balance") || 0) / 100;
                        App.cur = P(r, "depositCurrency") || "USD";
                        UI.upd();
                        Logic.syms();
                    } else log("AccErr:" + JSON.stringify(r));
                });
            },
            syms: () => {
                Tunnel.send(841, { includeArchivedSymbols: false }, r => {
                    const s = P(r, "symbol");
                    if (s) {
                        const el = document.getElementById('sym');
                        el.innerHTML = "<option>Select...</option>";
                        s.sort((a, b) => P(a, "name").localeCompare(P(b, "name")));
                        s.forEach(x => {
                            const o = document.createElement('option');
                            o.value = P(x, "id");
                            o.text = P(x, "name");
                            el.add(o);
                        });
                        el.onchange = () => Logic.sel(el.value);
                    }
                });
            },
            sel: (sid) => {
                sid = parseInt(sid);
                log(`Selecting ${sid}...`);
                Tunnel.send(163, { symbolId: [sid] }, r => { // Details
                    const l = P(r, "symbol");
                    if (l && l[0]) {
                        App.sym = l[0];
                        log(`Details OK. Step=${P(App.sym, "stepVolume")}. Subscribing...`);
                        Tunnel.send(601, { symbolId: [sid], subscribeToSpotTimestamp: true });
                        Logic.calc();
                    } else log("DetErr:" + JSON.stringify(r));
                });
            },
            onQuote: (msg) => {
                // Try to find payload
                let q = P(msg, "payload");
                if (!q) q = msg; // Flat?

                const sid = P(q, "symbolId");
                if (App.sym && P(App.sym, "id") == sid) {
                    const bid = P(q, "bid");
                    if (bid) {
                        App.bid = bid / 100000;
                        UI.upd();
                        Logic.calc();
                        // log(`Quote: ${App.bid}`); // Too spammy if working
                    }
                } else {
                    if (App.sym) log(`QuoteMismatch: Got ${sid} Want ${P(App.sym, "id")}`);
                }
            },
            calc: () => {
                if (!App.sym || !App.bid) return;
                const r = parseFloat(document.getElementById('risk').value);
                const sl = parseFloat(document.getElementById('sl').value);
                const bal = App.bal;

                let pv = 10;
                if (P(App.sym, "name").includes("JPY")) pv = 1000 / App.bid;

                const riskAmt = bal * (r / 100);
                let raw = riskAmt / (sl * pv);

                // Norm
                let units = raw * 100000;
                let step = P(App.sym, "stepVolume") || 1000;
                if (step > 10000) step = step / 100;
                units = Math.floor(units / step) * step;

                App.vol = units;
                document.getElementById('vol').innerText = (units / 100000).toFixed(2) + " Lots";
                document.getElementById('trade').disabled = (units <= 0);
            },
            trade: () => {
                if (App.vol <= 0) return;
                log(`Ordering ${App.vol} units...`);
                const cmd = {
                    symbolId: P(App.sym, "id"),
                    orderType: 1, tradeSide: 1, volume: App.vol
                };
                Tunnel.send(143, cmd, r => {
                    log("OrdRes:" + JSON.stringify(r));
                    if (P(r, "errorCode")) alert("Error: " + P(r, "errorCode"));
                    else alert("Success!");
                });
            }
        };

        const UI = {
            upd: () => {
                document.getElementById('acc').innerText = `${App.acc} | ${App.bal.toFixed(2)} ${App.cur}`;
                document.getElementById('price').innerText = App.bid.toFixed(3);
            }
        }
        function log(x) { document.getElementById('log').textContent = `> ${x}\n` + document.getElementById('log').textContent.substring(0, 1000); }
        window.onload = Logic.init;
    </script>
</head>

<body>
    <div class="card">
        <div class="label">Account</div>
        <div class="val" id="acc">Loading...</div>
    </div>

    <div class="card">
        <div class="label">Symbol</div>
        <select id="sym"></select>
        <div class="val" id="price" style="margin-top:10px; color:#448aff">---</div>
    </div>

    <div class="card">
        <div class="row" style="gap:10px">
            <div>
                <div class="label">Risk %</div><input id="risk" type="number" value="1.0" step="0.1">
            </div>
            <div>
                <div class="label">SL (Pips)</div><input id="sl" type="number" value="20">
            </div>
        </div>
    </div>

    <div class="card">
        <div class="label">Volume</div>
        <div class="val" id="vol" style="color:#00e676">0.00 Lots</div>
        <button id="trade" class="trade" disabled>TRADE</button>
    </div>

    <div id="log">Logs...</div>
</body>

</html>